local coreGui = game:GetService("CoreGui")
local camera = workspace.CurrentCamera

-- UI container
local drawingUI = Instance.new("ScreenGui")
drawingUI.Name = "Drawing"
drawingUI.IgnoreGuiInset = true
drawingUI.DisplayOrder = 0x7fffffff
drawingUI.Parent = coreGui

-- variables
local drawingIndex = 0
local uiStrokes = table.create(0)

-- base drawing object
local baseDrawingObj = setmetatable({
	Visible = true,
	ZIndex = 0,
	Transparency = 1,
	Color = Color3.new(),
	Remove = function(self)
		setmetatable(self, nil)
	end,
	Destroy = function(self)
		setmetatable(self, nil)
	end
}, {
	__add = function(t1, t2)
		local result = table.clone(t1)
		for index, value in t2 do
			result[index] = value
		end
		return result
	end
})

-- font enum mapping
local drawingFontsEnum = {
	[0] = Font.fromEnum(Enum.Font.Roboto),
	[1] = Font.fromEnum(Enum.Font.Legacy),
	[2] = Font.fromEnum(Enum.Font.SourceSans),
	[3] = Font.fromEnum(Enum.Font.RobotoMono),
	[4] = Font.fromEnum(Enum.Font.Arial)
}

local function getFontFromIndex(fontIndex)
	return drawingFontsEnum[fontIndex or 0]
end

local function convertTransparency(transparency)
	return math.clamp(1 - transparency, 0, 1)
end

-- DrawingLib table
local DrawingLib = {}
DrawingLib.Fonts = {
	["UI"] = 0,
	["System"] = 1,
	["Plex"] = 2,
	["Monospace"] = 3,
	["Arial"] = 4
}

-- main constructor
function DrawingLib.new(drawingType)
	drawingIndex += 1

	-- LINE
	if drawingType == "Line" then
		local lineObj = ({
			From = Vector2.zero,
			To = Vector2.zero,
			Thickness = 1
		} + baseDrawingObj)

		local lineFrame = Instance.new("Frame")
		lineFrame.Name = tostring(drawingIndex)
		lineFrame.AnchorPoint = Vector2.one * 0.5
		lineFrame.BorderSizePixel = 0
		lineFrame.BackgroundColor3 = lineObj.Color
		lineFrame.BackgroundTransparency = convertTransparency(lineObj.Transparency)
		lineFrame.ZIndex = lineObj.ZIndex
		lineFrame.Visible = lineObj.Visible
		lineFrame.Size = UDim2.new()
		lineFrame.Parent = drawingUI

		return setmetatable({}, {
			__newindex = function(_, index, value)
				if lineObj[index] == nil then return end
				if index == "From" or index == "To" then
					local from = index == "From" and value or lineObj.From
					local to = index == "To" and value or lineObj.To
					local direction = to - from
					local center = (to + from) / 2
					lineFrame.Position = UDim2.fromOffset(center.X, center.Y)
					lineFrame.Rotation = math.deg(math.atan2(direction.Y, direction.X))
					lineFrame.Size = UDim2.fromOffset(direction.Magnitude, lineObj.Thickness)
				elseif index == "Thickness" then
					local distance = (lineObj.To - lineObj.From).Magnitude
					lineFrame.Size = UDim2.fromOffset(distance, value)
				elseif index == "Visible" then
					lineFrame.Visible = value
				elseif index == "ZIndex" then
					lineFrame.ZIndex = value
				elseif index == "Transparency" then
					lineFrame.BackgroundTransparency = convertTransparency(value)
				elseif index == "Color" then
					lineFrame.BackgroundColor3 = value
				end
				lineObj[index] = value
			end,
			__index = function(_, index)
				if index == "Remove" or index == "Destroy" then
					return function()
						lineFrame:Destroy()
						lineObj.Remove(_)
						return lineObj:Remove()
					end
				end
				return lineObj[index]
			end,
			__tostring = function() return "Drawing" end
		})

	-- TEXT
	elseif drawingType == "Text" then
		local textObj = ({
			Text = "",
			Font = DrawingLib.Fonts.UI,
			Size = 14,
			Position = Vector2.zero,
			Center = false,
			Outline = false,
			OutlineColor = Color3.new()
		} + baseDrawingObj)

		local textLabel, uiStroke = Instance.new("TextLabel"), Instance.new("UIStroke")
		textLabel.Name = tostring(drawingIndex)
		textLabel.AnchorPoint = Vector2.one * 0.5
		textLabel.BorderSizePixel = 0
		textLabel.BackgroundTransparency = 1
		textLabel.Visible = textObj.Visible
		textLabel.TextColor3 = textObj.Color
		textLabel.TextTransparency = convertTransparency(textObj.Transparency)
		textLabel.ZIndex = textObj.ZIndex
		textLabel.FontFace = getFontFromIndex(textObj.Font)
		textLabel.TextSize = textObj.Size

		uiStroke.Thickness = 1
		uiStroke.Enabled = textObj.Outline
		uiStroke.Color = textObj.OutlineColor

		textLabel.Parent = drawingUI
		uiStroke.Parent = textLabel

		textLabel:GetPropertyChangedSignal("TextBounds"):Connect(function()
			local offset = textLabel.TextBounds / 2
			textLabel.Size = UDim2.fromOffset(textLabel.TextBounds.X, textLabel.TextBounds.Y)
			textLabel.Position = UDim2.fromOffset(textObj.Position.X + (not textObj.Center and offset.X or 0), textObj.Position.Y + offset.Y)
		end)

		return setmetatable({}, {
			__newindex = function(_, index, value)
				if textObj[index] == nil then return end
				if index == "Text" then
					textLabel.Text = value
				elseif index == "Font" then
					value = math.clamp(value, 0, 4)
					textLabel.FontFace = getFontFromIndex(value)
				elseif index == "Size" then
					textLabel.TextSize = value
				elseif index == "Position" then
					local offset = textLabel.TextBounds / 2
					textLabel.Position = UDim2.fromOffset(value.X + (not textObj.Center and offset.X or 0), value.Y + offset.Y)
				elseif index == "Center" then
					local position = value and camera.ViewportSize / 2 or textObj.Position
					textLabel.Position = UDim2.fromOffset(position.X, position.Y)
				elseif index == "Outline" then
					uiStroke.Enabled = value
				elseif index == "OutlineColor" then
					uiStroke.Color = value
				elseif index == "Visible" then
					textLabel.Visible = value
				elseif index == "ZIndex" then
					textLabel.ZIndex = value
				elseif index == "Transparency" then
					local transparency = convertTransparency(value)
					textLabel.TextTransparency = transparency
					uiStroke.Transparency = transparency
				elseif index == "Color" then
					textLabel.TextColor3 = value
				end
				textObj[index] = value
			end,
			__index = function(_, index)
				if index == "Remove" or index == "Destroy" then
					return function()
						textLabel:Destroy()
						textObj.Remove(_)
						return textObj:Remove()
					end
				elseif index == "TextBounds" then
					return textLabel.TextBounds
				end
				return textObj[index]
			end,
			__tostring = function() return "Drawing" end
		})

	end
end

return DrawingLib
